---
import Layout from '../../layouts/Layout.astro';
import NavBar from '../../components/NavBar';
import Footer from '../../components/Footer';
import { getAllPosts, getPostBySlug, formatDate, getRelatedPosts } from '../../lib/content';
import type { BlogPost } from '../../lib/content';

export async function getStaticPaths() {
  console.log('🔄 Generating static paths for blog posts...');
  const posts = await getAllPosts();

  console.log(`✅ Found ${posts.length} posts for static generation`);

  return posts.map((post: BlogPost) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

// Get post content and metadata
console.log(`📄 Loading post: ${post.data.title}`);

// Render the content
const { Content } = await post.render();

// No need to process components - they're inline in MDX

// Get related posts
const relatedPosts = await getRelatedPosts(post, 3);

// Format data for display
const formattedDate = formatDate(post.data.date);
const featuredImage = post.data.featuredImage;

// SEO data
const title = `${post.data.title} | ${process.env.SITE_NAME || 'PlayPhysio Blog'}`;
const description = post.data.excerpt;
const featuredImageUrl = featuredImage?.src;
const canonical = `${process.env.SITE_URL || 'https://playphysio.com'}/blog/${post.slug}`;
const publishedTime = new Date(post.data.date).toISOString();
const modifiedTime = publishedTime; // Use published time as modified time for now
const authorName = 'PlayPhysio Team';
const postTags = post.data.tags;
---

<Layout
  title={title}
  description={description}
  image={featuredImageUrl}
  canonical={canonical}
  type="article"
  publishedTime={publishedTime}
  modifiedTime={modifiedTime}
  author={authorName}
  tags={postTags}
>
  <NavBar client:load />

  <main>
    <!-- Sticky Sub-Header Navigation -->
    <div class="sticky-sub-header">
      <div class="sub-header-container">
        <a href="/blog" class="back-to-news-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m15 18-6-6 6-6"></path>
          </svg>
          Back to News
        </a>
      </div>
    </div>

    <!-- Basic Styles -->
    <style>
      /* Ensure main doesn't interfere with sticky */
      main {
        position: relative;
        overflow: visible;
      }

      /* Sticky Sub-Header */
      .sticky-sub-header {
        position: -webkit-sticky;
        position: sticky;
        top: 4rem; /* Height of main navigation (h-16 = 4rem) */
        z-index: 1000;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        width: 100%;
        margin-bottom: 0;
      }

      .sub-header-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
      }

      .back-to-news-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        padding: 0.5rem 0;
      }

      .back-to-news-link:hover {
        color: #4DBBFA;
      }

      .back-to-news-link svg {
        transition: transform 0.2s ease;
      }

      .back-to-news-link:hover svg {
        transform: translateX(-2px);
      }

      .post-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 3rem 1rem;
        color: #333;
        min-height: 80vh;
      }

      /* V0 Style Meta Header */
      .post-meta-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .category-badge {
        background: linear-gradient(135deg, #22d3ee 0%, #10b981 100%);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }

      .meta-items {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1rem;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.875rem;
        color: #6b7280;
      }

      /* V0 Style Title */
      .post-title-v0 {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1f2937;
        line-height: 1.2;
        margin-bottom: 2rem;
      }

      @media (min-width: 768px) {
        .post-title-v0 {
          font-size: 3rem;
        }
      }

      /* V0 Style Featured Image */
      .featured-image-container-v0 {
        position: relative;
        margin-bottom: 3rem;
      }

      .featured-image-v0 {
        width: 100%;
        height: 16rem;
        object-fit: cover;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      @media (min-width: 768px) {
        .featured-image-v0 {
          height: 24rem;
        }
      }

      .post-content {
        font-size: 1.125rem;
        line-height: 1.75;
        color: #374151;
        font-family: 'Inter', system-ui, sans-serif;
      }

      .post-content p {
        margin-bottom: 1.5rem;
        color: #4b5563;
      }

      .post-content strong {
        font-weight: 600;
        color: #1f2937;
      }

      .post-content em {
        font-style: italic;
        color: #6b7280;
      }

      /* List styling */
      .post-content ul,
      .post-content ol {
        margin: 1.5rem 0;
        padding-left: 1.5rem;
      }

      .post-content ul li {
        margin-bottom: 0.5rem;
        position: relative;
      }

      .post-content ul li::marker {
        color: #4DBBFA;
      }

      .post-content ol li {
        margin-bottom: 0.5rem;
      }

      .post-content ol li::marker {
        color: #9B59B6;
        font-weight: 600;
      }

      /* Links */
      .post-content a {
        color: #4DBBFA;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .post-content a:hover {
        color: #58D68D;
        text-decoration: underline;
      }

      .post-content img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
      }

      /* Blog Content Headers - Integrated with Site Design System */
      :global(.post-content h1) {
        font-size: 2.5rem !important;
        font-weight: 800 !important;
        margin-top: 3rem !important;
        margin-bottom: 1.5rem !important;
        background: linear-gradient(135deg, #4DBBFA 0%, #58D68D 100%) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        line-height: 1.2 !important;
        letter-spacing: -0.025em !important;
      }

      :global(.post-content h2) {
        font-size: 2rem !important;
        font-weight: 700 !important;
        margin-top: 2.5rem !important;
        margin-bottom: 1.25rem !important;
        background: linear-gradient(135deg, #9B59B6 0%, #4DBBFA 100%) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        line-height: 1.3 !important;
        letter-spacing: -0.025em !important;
      }

      :global(.post-content h3) {
        font-size: 1.5rem !important;
        font-weight: 600 !important;
        margin-top: 2rem !important;
        margin-bottom: 1rem !important;
        color: #1f2937 !important;
        line-height: 1.4 !important;
      }

      :global(.post-content h4) {
        font-size: 1.25rem !important;
        font-weight: 600 !important;
        margin-top: 1.5rem !important;
        margin-bottom: 0.75rem !important;
        color: #374151 !important;
        line-height: 1.4 !important;
      }

      :global(.post-content h5) {
        font-size: 1.125rem !important;
        font-weight: 600 !important;
        margin-top: 1.5rem !important;
        margin-bottom: 0.75rem !important;
        color: #4b5563 !important;
        line-height: 1.4 !important;
      }

      :global(.post-content h6) {
        font-size: 1rem !important;
        font-weight: 600 !important;
        margin-top: 1.25rem !important;
        margin-bottom: 0.5rem !important;
        color: #6b7280 !important;
        line-height: 1.4 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.05em !important;
      }

      /* Responsive header sizing */
      @media (max-width: 768px) {
        :global(.post-content h1) {
          font-size: 2rem !important;
        }

        :global(.post-content h2) {
          font-size: 1.75rem !important;
        }

        :global(.post-content h3) {
          font-size: 1.375rem !important;
        }
      }

      .post-content blockquote {
        border-left: 4px solid #3498db;
        padding-left: 1rem;
        margin: 1.5rem 0;
        font-style: italic;
        color: #555;
      }

      .post-content pre {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
      }

      .post-content code {
        background: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-size: 0.9em;
      }

      .post-footer {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #eee;
      }

      .categories,
      .tags {
        margin-bottom: 1rem;
      }

      .tags-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #e5e7eb;
      }

      .tags-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .tag-badge {
        display: inline-flex;
        align-items: center;
        background: #f3f4f6;
        color: #374151;
        padding: 0.5rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
        border: 1px solid transparent;
      }

      .tag-badge:hover {
        background: #ecfdf5;
        color: #059669;
        border-color: #d1fae5;
        transform: translateY(-1px);
      }

      .category-tag {
        display: inline-block;
        background: linear-gradient(135deg, #22d3ee 0%, #10b981 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        margin: 0.2rem 0.3rem 0.2rem 0;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }

      .category-tag:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(34, 211, 238, 0.3);
      }

      .navigation {
        margin-top: 2rem;
        text-align: center;
      }

      .nav-link {
        color: #3498db;
        text-decoration: none;
        font-weight: 500;
      }

      .nav-link:hover {
        text-decoration: underline;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .post-title {
          font-size: 2rem;
        }

        .post-content {
          font-size: 1rem;
        }
      }
    </style>

    <!-- Rich content components have their own styles -->

    <div class="post-container">
      <article>
      {/* Meta Info Above Title - V0 Style */}
      <div class="post-meta-header">
        {post.data.categories.length > 0 && (
          <div class="category-badge">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
              <line x1="7" y1="7" x2="7.01" y2="7"></line>
            </svg>
            {post.data.categories[0]}
          </div>
        )}
        <div class="meta-items">
          <div class="meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span>{authorName}</span>
          </div>
          <div class="meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span>{formattedDate}</span>
          </div>
          <div class="meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12,6 12,12 16,14"></polyline>
            </svg>
            <span>{Math.ceil((post.data.wordCount || 500) / 200)} min read</span>
          </div>
        </div>
      </div>

      {/* Title - V0 Style */}
      <h1 class="post-title-v0">{post.data.title}</h1>

      {/* Featured Image - V0 Style */}
      {featuredImage && (
        <div class="featured-image-container-v0">
          <img
            src={featuredImage.src}
            alt={featuredImage.alt || post.data.title}
            class="featured-image-v0"
            loading="eager"
          />
        </div>
      )}

      <div class="post-content">
        <Content />
      </div>

      {/* Tags Section - V0 Style */}
      {post.data.tags.length > 0 && (
        <div class="tags-section">
          <h3 class="tags-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
              <line x1="7" y1="7" x2="7.01" y2="7"></line>
            </svg>
            Tags
          </h3>
          <div class="tags-container">
            {post.data.tags.map((tag: string) => (
              <a href="#" class="tag-badge">
                {tag}
              </a>
            ))}
          </div>
        </div>
      )}

      <footer class="post-footer">
        {post.data.categories.length > 0 && (
          <div class="categories">
            <strong>Categories: </strong>
            {post.data.categories.map((category: string) => (
              <a href={`/blog?category=${category}`} class="category-tag">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                  <line x1="7" y1="7" x2="7.01" y2="7"></line>
                </svg>
                {category}
              </a>
            ))}
          </div>
        )}

        <div class="navigation">
          <a href="/blog" class="nav-link">← Back to Blog</a>
        </div>
      </footer>
      </article>
    </div>
  </main>

  <Footer client:load />
</Layout>
